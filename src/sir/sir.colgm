use std::str::{ str };
use std::ptr::{ ptr };
use std::vec::{ primitive_vec, vec };

use err::panic::{ unreachable };
use sir::value::{ value_t };

pub enum sir_kind {
    sir_null,
    sir_nop,
    sir_block,
    sir_alloca,
    sir_temp_ptr,
    sir_ret,
    sir_str,
    sir_zeroinitializer,
    sir_get_index,
    sir_get_field,
    sir_call,
    sir_neg,
    sir_bnot,
    sir_lnot,
    sir_add,
    sir_sub,
    sir_mul,
    sir_div,
    sir_rem,
    sir_band,
    sir_bxor,
    sir_bor,
    sir_cmp,
    sir_label,
    sir_store,
    sir_load,
    sir_br,
    sir_br_cond,
    sir_switch,
    sir_type_convert,
    sir_array_cast
}

pub enum sir_cmp_kind {
    cmp_eq,
    cmp_neq,
    cmp_ge,
    cmp_gt,
    cmp_le,
    cmp_lt
}

pub struct sir {
    kind: sir_kind
}

impl sir {
    pub func instance(kind: sir_kind) -> sir {
        return sir { kind: kind };
    }

    pub func delete(self) {
        match (self->kind) {
            _ => { unreachable(); }
        }
    }
}

pub struct sir_nop {
    base: sir,
    info: str
}

pub struct sir_block {
    base: sir,
    allocas: primitive_vec<ptr<sir_alloca>>,
    move_register: primitive_vec<ptr<sir_alloca>>,
    stmts: primitive_vec<ptr<sir>>
}

struct array_type_t {
    base_type: str,
    size: u64
}

pub struct sir_alloca {
    base: sir,
    variable: str,
    type: str,
    array_info: array_type_t    
}

pub struct sir_temp_ptr {
//
// used to get temporary pointer of numbering variable
//     %_1.real = alloca i32
// this operand will do this:
//     %1 = getelementptr i32, i32* %_1.real, i32 0
// and %1 is i32*
//
    base: sir,
    target: str,
    source: str,
    comment: str // for tail comment
}

pub struct sir_ret {
    base: sir,
    type: str,
    value: value_t
}

pub struct sir_str {
    base: sir,
    index: u64,
    length: u64,
    target: value_t
}

pub struct sir_zeroinitializer {
    base: sir,
    type: str,
    target: value_t
}

pub struct sir_get_index {
    base: sir,
    source: value_t,
    target: value_t,
    index: value_t,
    type: str,
    index_type: str
}

pub struct sir_get_field {
    base: sir,
    source: value_t,
    target: value_t,
    struct_name: str,
    index: u64
}

pub struct sir_call {
    base: sir,
    name: str,
    return_type: str,
    target: value_t,
    args_type: vec<str>,
    args: vec<value_t>,
    with_va_args: bool,
    with_va_args_real_param_size: u64,
    debug_info_index: u64
}

pub struct sir_neg {
    base: sir,
    target: value_t,
    source: value_t,
    is_integer: bool,
    type: str
}

pub struct sir_bnot {
    base: sir,
    target: value_t,
    source: value_t,
    type: str
}

pub struct sir_lnot {
    base: sir,
    target: value_t,
    source: value_t,
    type: str
}

pub struct sir_add {
    base: sir,
    target: value_t,
    left: value_t,
    right: value_t,
    is_integer: bool,
    type: str
}

pub struct sir_sub {
    base: sir,
    target: value_t,
    left: value_t,
    right: value_t,
    is_integer: bool,
    type: str
}

pub struct sir_mul {
    base: sir,
    target: value_t,
    left: value_t,
    right: value_t,
    is_integer: bool,
    type: str
}

pub struct sir_div {
    base: sir,
    target: value_t,
    left: value_t,
    right: value_t,
    is_integer: bool,
    is_signed: bool,
    type: str
}

pub struct sir_rem {
    base: sir,
    target: value_t,
    left: value_t,
    right: value_t,
    is_integer: bool,
    is_signed: bool,
    type: str
}

pub struct sir_band {
    base: sir,
    target: value_t,
    left: value_t,
    right: value_t,
    type: str
}

pub struct sir_bxor {
    base: sir,
    target: value_t,
    left: value_t,
    right: value_t,
    type: str
}

pub struct sir_bor {
    base: sir,
    target: value_t,
    left: value_t,
    right: value_t,
    type: str
}

pub struct sir_cmp {
    base: sir,
    target: value_t,
    left: value_t,
    right: value_t,
    kind: sir_cmp_kind,
    is_integer: bool,
    is_signed: bool,
    type: str
}

pub struct sir_label {
    base: sir,
    label: u64,
    comment: str
}

pub struct sir_store {
    base: sir,
    target: value_t,
    source: value_t,
    type: str
}

pub struct sir_load {
    base: sir,
    target: value_t,
    source: value_t,
    type: str
}

pub struct sir_br {
    base: sir,
    label: u64
}

pub struct sir_br_cond {
    base: sir,
    cond: value_t,
    label_true: u64,
    label_false: u64
}

pub struct sir_switch {
    base: sir,
    source: value_t,
    default_label: u64,
    case_value: primitive_vec<i64>,
    case_label: primitive_vec<u64>
}

pub struct sir_type_convert {
    base: sir,
    target: value_t,
    source: value_t,
    src_type: str,
    dst_type: str
}

pub struct sir_array_cast {
    base: sir,
    target: value_t,
    source: value_t,
    type: str,
    array_size: u64
}

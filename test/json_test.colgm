use std::json::{ json };
use std::str::{ str };
use std::io::{ io };
use std::libc::{ free };

func dump_json_value(input: str*) {
    var j = json::parse(input);
    defer {
        j->delete();
        free(j => i8*);
    }

    io::stdout().out("[json test] raw  : ").out(input->c_str).endln();
    if (j->is_invalid()) {
        io::stdout().out("[json test] error: ").out(j->get_error()->c_str).endln();
    } else {
        var s = j->to_string();
        defer s.delete();
        io::stdout().out("[json test] json : ").out(s.c_str).endln();
    }
}

func test_json_parse() {
    var input = str::instance();
    defer input.delete();

    input.append("{\"vec<num>\": [0, 0.0, -1.01, +2e4]}");
    dump_json_value(input.__ptr__());
    input.clear();

    input.append("[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, null, true, false, \"\\\"\\\\\\/\\b\\f\\n\\r\\t\"]");
    dump_json_value(input.__ptr__());
    input.clear();

    input.append("[\"\\\"\\\'\"]");
    dump_json_value(input.__ptr__());
    input.clear();

    // unterminated string
    input.append("[\"\\ \\\'");
    dump_json_value(input.__ptr__());
    input.clear();

    // invalid escape sequence
    input.append("[\"\\");
    dump_json_value(input.__ptr__());
    input.clear();

    input.append("[  \n\n\n\r\r\r\t\t\t  ]");
    dump_json_value(input.__ptr__());
    input.clear();
}

func make_num_arr() -> json* {
    var arr = json::arr();
    for (var i = 0; i < 10; i += 1) {
        arr->json_array.push(json::num(i => f64));
    }
    return arr;
}

func make_bool_arr() -> json* {
    var arr = json::arr();
    for (var i = 0; i < 10; i += 1) {
        arr->json_array.push(json::bool(i % 2 == 0));
    }
    return arr;
}

func make_str_arr() -> json* {
    var arr = json::arr();
    for (var i = 0; i < 10; i += 1) {
        var s = json::str("hello world - ");
        s->json_string.append_i64(i);
        arr->json_array.push(s);
    }
    return arr;
}

func main() -> i32 {
    var obj = json::obj();
    defer {
        obj->delete();
        free(obj => i8*);
    }

    var another_obj = json::obj();

    var key_obj = str::from("json_object");
    defer key_obj.delete();
    obj->json_object.insert(key_obj.__ptr__(), another_obj);

    var key_num_arr = str::from("json_num_array");
    var key_bool_arr = str::from("json_bool_array");
    var key_str_arr = str::from("json_str_array");
    defer key_num_arr.delete();
    defer key_bool_arr.delete();
    defer key_str_arr.delete();
    obj->json_object.insert(key_num_arr.__ptr__(), make_num_arr());
    obj->json_object.insert(key_bool_arr.__ptr__(), make_bool_arr());
    obj->json_object.insert(key_str_arr.__ptr__(), make_str_arr());
    another_obj->json_object.insert(key_num_arr.__ptr__(), make_num_arr());
    another_obj->json_object.insert(key_bool_arr.__ptr__(), make_bool_arr());
    another_obj->json_object.insert(key_str_arr.__ptr__(), make_str_arr());

    var key_num = str::from("json_num");
    defer key_num.delete();
    obj->json_object.insert(key_num.__ptr__(), json::num(114.514));

    var key_str = str::from("json_str");
    defer key_str.delete();
    obj->json_object.insert(key_str.__ptr__(), json::str("hello world"));

    var res = obj->to_string();
    defer res.delete();
    io::stdout().out(res.c_str).endln();

    test_json_parse();
    return 0;
}
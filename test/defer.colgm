use std::io::{ io };
use err::panic::{ panic };

struct structure_for_test {
    freed: bool
}

impl structure_for_test {
    pub func new() -> structure_for_test {
        return structure_for_test {
            freed: false
        };
    }

    pub func delete(self) {
        if (self->freed) {
            panic("double free");
        }
        self->freed = true;
    }
}

func test_0() {
    var a = structure_for_test::new();
    defer {
        io::stdout().out("test 0: delete a\n");
        a.delete();
    }

    if (1 == 1) {}
    if (1 != 1) {} else {}

    for (var i = 0; i < 10; i += 1) {
        if (i == 5) {
            return;
        }
    }
}

func test_1() {
    var a = structure_for_test::new();
    defer {
        io::stdout().out("test 1: delete a\n");
        a.delete();
    }

    if (1 == 1) {}
    if (1 != 1) {} else {}
}

func test_2() {
    var a = structure_for_test::new();
    defer io::stdout().out("test 2: delete a\n");
    defer a.delete();

    if (1 == 1) {}
    if (1 != 1) {} else {}
}

func test_3() {
    for (var i = 0; i < 10; i += 1) {
        var a = structure_for_test::new();
        defer io::stdout().out("test 3: delete a (").out_i64(i).out(")\n");
        defer a.delete();

        if (1 == 1) {
            var b = structure_for_test::new();
            defer io::stdout().out("test 3: delete b (").out_i64(i).out(")\n");
            defer b.delete();
            if (1 != 1) {} else {
                var c = structure_for_test::new();
                defer io::stdout().out("test 3: delete c (").out_i64(i).out(")\n");
                defer c.delete();
            }
        }
        if (1 != 1) {} else {}
    }
}

func main() -> i32 {
    test_0();
    test_1();
    test_2();
    test_3();

    var outer = structure_for_test::new();
    defer io::stdout().out("main: delete outer").endln();
    defer outer.delete();

    for (var i = 0; i < 10; i += 1) {
        var a = structure_for_test::new();
        defer io::stdout().out("delete a\n");
        defer a.delete();

        if (i == 9) {
            io::stdout().out("main: ( break    ) ").out_i64(i).out(" ");
            break;
        }
        if (i == 6 || i == 7) {
            io::stdout().out("main: ( continue ) ").out_i64(i).out(" ");
            continue;
        }

        io::stdout().out("main: ( loop     ) ").out_i64(i).out(" ");
    }
    return 0;
}